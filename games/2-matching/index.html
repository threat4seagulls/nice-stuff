<!DOCTYPE html>
<meta charset="utf-8"/>
<title>2Matching</title>
<script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"> </script>
<script type="text/javascript" src="node_modules/handlebars/dist/handlebars.min.js"> </script>

<link rel="stylesheet" href="css/bundle.min.css"/>

<div class="layout">
	<h1> Find all matching Pusheens! </h1>
	<div id="control-panel"> </div>
	<div id="gamefield"> </div>
</div>


<script id="control-panel-template" type="text/x-handlebars-template">
	<div id="timer"> </div>
	{{#each data}}
	<div class="complexity-holder" id="{{num}}" onclick="changeComplexity($(this));">
		<div class="complexity-item" >{{num}} tiles:</div>
		<div class="complexity-best"> {{record}} </div>
	</div>
	{{/each}}
	<div id="restart" onclick="restartGame($(this));"> Restart </div>
</script>


<script id="gamefield-template" type="text/x-handlebars-template">
	{{#each images}}
		<div class="tile-row">
		{{#each this}}
			<div class="tile" id="{{id}}" onclick="clickedTile($(this));">
				<img class="img" src="{{src}}"/><img class="cover" src="pusheen/cover.jpg"/>
			</div>
		{{/each}}
		</div>
	{{/each}}

</script>


<script> 

var timer, gameIsOn = false, tileOpened;
var defaultNumber = 4;
var pairsLeft, pairsTotal;

function initGamefield(number) {

	function generateImages(number) {
		function shuffle(o){
			for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
			return o;
		}

		var imgNumbers = [], images=[];
		for (var i=0;i<number;i++)
			for (var j=0;j<number/2;j++) {
				imgNumbers.push(j*number+i+1);			
				imgNumbers.push(j*number+i+1);			
			}
		imgNumbers = shuffle(imgNumbers);
		for (var i=0;i<number;i++) {
			images.push([]);			
			for (var j=0;j<number;j++) {
				images[i].push({src:'pusheen/'+(imgNumbers[j*number+i]).toString()+'.jpg', id: (imgNumbers[j*number+i]).toString()+':'+(j*number+i).toString()});
			}
		}
		return images;
	}

	var images = generateImages(number);
	var template = Handlebars.compile($('#gamefield-template').html());
	var html = template({images: images});
	$('#gamefield').html(html);	
}

function initControlPanel(data) {
	var template = Handlebars.compile($('#control-panel-template').html());
	var html = template({data: data});
	$('#control-panel').html(html);	
}

function onGameOver() {
	gameIsOn = false;
	clearInterval(timer);
	if (pairsLeft == 0) {
		console.log("YAY");
	}
}


function changeComplexity(elem) {
	elems = $('.complexity-holder');
		for (var i=0;i<elems.length;i++)
			if ($(elems[i]).hasClass("current")) $(elems[i]).removeClass("current");
	$(elem).addClass('current');
	number = parseInt($(elem).attr("id"));
	initGamefield(number);
	pairsLeft = number*number/2, pairsTotal = number*number/2;
	onGameOver();
}

function clickedTile(elem) {
	if ($(elem).hasClass("fixed")) return;
	if (!gameIsOn) {
		gameIsOn = true;
		startClock();	
	}
	$(elem).toggleClass("selected");
	if (tileOpened != null) {
		id1 = $(elem).attr('id'), id2 = $(tileOpened).attr('id');
		if (id1!=id2 && id1.slice(0,id1.indexOf(':')) == id2.slice(0,id2.indexOf(':'))) {
			$(elem).addClass("fixed");
			$(tileOpened).addClass("fixed");
			pairsLeft -=1;
			if (pairsLeft === 0) {
				onGameOver();
			}
		}
		else {
			setTimeout(function(elem1, elem2) {
				$(elem1).removeClass('selected');
				$(elem2).removeClass('selected');
			}, 650, elem, tileOpened);
		}
		tileOpened = null;
	}
	else 
		tileOpened = elem;

}

function clearClock() {
	$("#timer").text("00:00:00");
}
function startClock() {
	function forOutput(num) {
		return (num / 10 >= 1 ? "" : "0") + num.toString(); 
	}	

	h = 0; m = 0; s = 0;
	timer = setInterval(function() {
		s += 1;
		if (s == 60) 
		{
			s = 0; m += 1;
			if (m == 60) 
			{
				m = 0; h += 1;
				if (h == 24)
				{
					clearInterval(timer);
					clearClock();
				} 
			}
		}
		$("#timer").text(forOutput(h) + ":" + forOutput(m) + ":" + forOutput(s));
	}, 1000);
}


function restartGame() {
	number = parseInt($('.complexity-holder.current').attr('id'));
	initGamefield(number);
	pairsLeft = pairsTotal;
	onGameOver();
}

$(document).ready(function() {

	initControlPanel([{'num':2, 'record': '0.0.0'}, {'num':4, 'record': '0.0.0'}, {'num':6, 'record': '0.0.0'}, {'num':8, 'record': '0.0.0'}]);
	initGamefield(defaultNumber);
	$('.complexity-holder#'+defaultNumber.toString()).addClass('current');
	pairsLeft = defaultNumber*defaultNumber/2, pairsTotal = defaultNumber*defaultNumber/2;
	clearClock();
});


</script>